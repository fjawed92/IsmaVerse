{% extends "base.html" %}
{% block title %}{{ comic.title }} - Reader{% endblock %}

{% block content %}
<div class="comic-panel mb-4">
  <div class="panel-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <h1 class="panel-title mb-0">{{ comic.title }}</h1>
      <div class="text-white-50" style="font-weight:900;">
        {{ comic.pdf_file }}
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <a class="btn btn-outline-light fw-bold"
         href="{{ url_for('comics.comic_detail', comic_id=comic.id) }}">
        ← Back
      </a>
      <button class="btn btn-outline-light fw-bold" id="prevBtn">← Prev</button>
      <button class="btn btn-outline-light fw-bold" id="nextBtn">Next →</button>
    </div>
  </div>

  <div class="p-3 p-md-4">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <span class="burst">PAGE</span>
        <div class="fw-bold">
          <span id="pageNum">1</span> / <span id="pageCount">?</span>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-comic-cta" id="zoomOut">-</button>
        <div class="fw-bold">Zoom: <span id="zoomLabel">100%</span></div>
        <button class="btn btn-comic-cta" id="zoomIn">+</button>
      </div>
    </div>

    <div class="reader-stage">
      <div class="page-frame" id="pageFrame" aria-label="Comic page">
        <canvas id="pdfCanvas"></canvas>
      </div>
    </div>

    <div id="readerStatus"
         class="mt-3"
         style="display:none; border:4px solid var(--ink); border-radius:14px; padding:12px; background:#fff; box-shadow: var(--shadow); font-weight:800;">
    </div>
  </div>
</div>

<script>
  window.COMIC_READER = {
    pdfUrl: "{{ url_for('comics.serve_pdf', filename=comic.pdf_file) }}",
    workerUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.3.122/legacy/build/pdf.worker.min.js"
  };
</script>

<!-- PDF.js FIRST (global pdfjsLib) -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.3.122/legacy/build/pdf.min.js"></script>

<!-- Guard / Debug -->
<script>
  (function () {
    const statusEl = document.getElementById("readerStatus");
    function show(msg){
      statusEl.style.display = "block";
      statusEl.style.background = "#fff1f1";
      statusEl.innerHTML = msg;
    }

    if (!window.COMIC_READER || !window.COMIC_READER.pdfUrl) {
      console.error("Comic Reader: missing COMIC_READER.pdfUrl");
      show("❌ Missing <strong>COMIC_READER.pdfUrl</strong>.");
      return;
    }

    if (typeof window.pdfjsLib === "undefined") {
      console.error("PDF.js failed to load: pdfjsLib undefined");
      show("❌ PDF.js failed to load (pdfjsLib is undefined). Check Network tab for <code>pdf.min.js</code>.");
      return;
    }
  })();
</script>

<!-- Your reader logic -->
<script defer src="{{ url_for('static', filename='js/comic_reader.js') }}?v=4"></script>

{% endblock %}
